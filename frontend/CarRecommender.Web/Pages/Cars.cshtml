@page
@model CarsModel
@{
    ViewData["Title"] = "Blader door auto's";
}

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        // Normaliseer naar Nederlandse termen
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        // Als het niet herkend wordt, retourneer de originele waarde met hoofdletter
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
    
    /// <summary>
    /// Converteert vermogen van KW naar PK (paardenkracht).
    /// Dataset bevat vermogen in KW, maar we tonen het in PK voor gebruikers.
    /// Conversie: 1 KW = 1.35962 PK (afgerond naar 1.36)
    /// </summary>
    int ConvertKwToHp(int powerKw)
    {
        return (int)Math.Round(powerKw * 1.35962);
    }

    /// <summary>
    /// Formatteert body type naar Nederlandse termen met hoofdletters.
    /// </summary>
    string FormatBodyType(string? bodyType)
    {
        if (string.IsNullOrWhiteSpace(bodyType))
            return "Niet opgegeven";
        
        string lower = bodyType.ToLower().Trim();
        
        // Map naar Nederlandse termen met hoofdletters
        return lower switch
        {
            "suv" => "SUV",
            "sedan" => "Sedan",
            "hatchback" => "Hatchback",
            "station" => "Station",
            "cabrio" => "Cabrio",
            "coupe" => "Coupé",
            "wagon" => "Station",
            "convertible" => "Cabrio",
            _ => char.ToUpper(bodyType[0]) + (bodyType.Length > 1 ? bodyType.Substring(1).ToLower() : "")
        };
    }
}

<style>
    :root {
        --deep-purple: #4A148C;
        --purple-dark: #311B92;
        --purple-light: #7B1FA2;
        --purple-accent: #9C27B0;
    }

    .hero-header {
        background: linear-gradient(135deg, #000000 0%, var(--deep-purple) 50%, var(--purple-dark) 100%);
        color: white;
        padding: 4rem 0;
        margin: -1rem -15px 3rem -15px;
        border-radius: 0 0 30px 30px;
    }

    .hero-header h1 {
        font-size: 3rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        padding: 0.5rem 1rem;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(74, 20, 140, 0.3);
        background: linear-gradient(135deg, var(--purple-dark) 0%, var(--deep-purple) 100%);
    }

    .car-card .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        transition: transform 0.2s, box-shadow 0.3s;
        overflow: hidden;
    }

    .car-card .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(74, 20, 140, 0.2);
    }

    .card-title {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .card-title a {
        color: var(--deep-purple);
        text-decoration: none;
        transition: color 0.2s;
    }

    .card-title a:hover {
        color: var(--purple-accent);
    }

    .card-text {
        line-height: 1.8;
        color: #333;
    }

    .card-text strong {
        color: var(--deep-purple);
    }

    .car-image-container {
        height: 200px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    .alert-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: none;
        border-left: 4px solid #d32f2f;
        color: #333;
        border-radius: 8px;
        padding: 1rem 1.5rem;
    }

    .stats-text {
        color: #666;
        font-size: 1.05rem;
        margin-top: 1rem;
    }

    .stats-text span {
        color: var(--deep-purple);
        font-weight: 600;
    }

    .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
    }

    @@media (max-width: 992px) {
        .hero-header h1 {
            font-size: 2rem;
        }
    }
</style>

<div class="hero-header">
    <div class="container-fluid">
        <div class="text-center">
            <h1>Blader door auto's</h1>
        </div>
    </div>
</div>

<div class="content-wrapper">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 2rem;">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.AllCars != null && Model.AllCars.Count > 0)
    {
        <div class="row" id="carsContainer">
            @foreach (var car in Model.AllCars)
            {
                if (car == null)
                {
                    continue;
                }
                
                var carId = car.Id;
                
                <div class="col-md-6 col-lg-4 mb-4 car-card">
                    <div class="card h-100" 
                         style="cursor: pointer;" 
                         onclick="navigateToCarDetail(@carId)">
                        @{
                            // Negeer API ImageUrl en probeer direct Auto-Data.net
                            var safeBrand = car.Brand?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                            var safeModel = car.Model?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                            var imageUrl = $"https://www.auto-data.net/images/{safeBrand}/{safeModel}.jpg";
                            
                            // Voor placeholder tekst
                            var brandLower = car.Brand?.ToLower() ?? "auto";
                            var modelLower = car.Model?.ToLower() ?? "";
                        }
                        <img src="@imageUrl" 
                             class="card-img-top car-image-container" 
                             alt="@car.Brand @car.Model"
                             style="object-fit: cover; display: block; width: 100%;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             loading="lazy">
                        <div class="car-placeholder" 
                             style="display: none; height: 200px; background: #2d2d2d; flex-direction: column; align-items: center; justify-content: center; color: #ccc;">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor" style="margin-bottom: 1rem;">
                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                            </svg>
                            <div style="font-size: 1.1rem; font-weight: 500; text-align: center;">
                                @brandLower<br>
                                @modelLower
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/car/@carId" 
                                   onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                                   data-car-id="@carId">
                                    @car.Brand @car.Model
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @car.Fuel<br>
                                <strong>Bouwjaar:</strong> @car.Year<br>
                                <strong>Vermogen:</strong> @ConvertKwToHp(car.Power) PK<br>
                                <strong>Transmissie:</strong> @FormatTransmission(car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @FormatBodyType(car.BodyType)<br>
                                }
                            </p>
                            <a href="/car/@carId" 
                               class="btn btn-primary btn-sm w-100" 
                               onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                               data-car-id="@carId">
                                Bekijk details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <p class="stats-text">
                    @Model.AllCars.Count auto's getoond
                </p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function navigateToCarDetail(carId) {
            if (carId == null || carId === undefined || isNaN(carId)) {
                console.error('Invalid carId:', carId);
                return;
            }
            
            const url = '/car/' + parseInt(carId, 10);
            console.log('Navigating to car detail:', url, 'for carId:', carId);
            
            window.location.href = url;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-car-id]').forEach(function(element) {
                if (!element.onclick) {
                    element.addEventListener('click', function(e) {
                        const carId = parseInt(this.getAttribute('data-car-id'), 10);
                        if (!isNaN(carId)) {
                            navigateToCarDetail(carId);
                        }
                    });
                }
            });
        });
    </script>
}
