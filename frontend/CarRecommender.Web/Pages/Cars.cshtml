@page
@model CarsModel
@{
    ViewData["Title"] = "Blader door auto's";
}

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        // Normaliseer naar Nederlandse termen
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        // Als het niet herkend wordt, retourneer de originele waarde met hoofdletter
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
    
    /// <summary>
    /// Converteert vermogen van KW naar PK (paardenkracht).
    /// Dataset bevat vermogen in KW, maar we tonen het in PK voor gebruikers.
    /// Conversie: 1 KW = 1.35962 PK (afgerond naar 1.36)
    /// </summary>
    int ConvertKwToHp(int powerKw)
    {
        return (int)Math.Round(powerKw * 1.35962);
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 mb-4">Blader door auto's</h1>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.AllCars != null && Model.AllCars.Count > 0)
    {
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Filters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="maxBudget" class="form-label">Maximaal budget: €<span id="budgetValue">@Model.AllCars.Max(c => c.Budget).ToString("N0")</span></label>
                                <input type="range" class="form-range" id="maxBudget" min="0" max="@Model.AllCars.Max(c => c.Budget)" value="@Model.AllCars.Max(c => c.Budget)" step="1000">
                            </div>
                            <div class="col-md-3">
                                <label for="fuelFilter" class="form-label">Brandstof</label>
                                <select class="form-select" id="fuelFilter">
                                    <option value="">Alle</option>
                                    @foreach (var fuel in Model.AllCars.Select(c => c.Fuel).Distinct().OrderBy(f => f))
                                    {
                                        <option value="@fuel">@fuel</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="minYear" class="form-label">Minimum bouwjaar: <span id="yearValue">@Model.AllCars.Min(c => c.Year)</span></label>
                                <input type="range" class="form-range" id="minYear" min="@Model.AllCars.Min(c => c.Year)" max="@Model.AllCars.Max(c => c.Year)" value="@Model.AllCars.Min(c => c.Year)" step="1">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-secondary mt-4" onclick="resetFilters()">Reset filters</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="carsContainer">
            @foreach (var car in Model.AllCars)
            {
                // DYNAMISCHE ROUTING: Elke auto-kaart gebruikt zijn eigen unieke ID
                // FIX: Check eerst of car niet null is
                if (car == null)
                {
                    continue; // Skip null cars
                }
                
                // FIX: Expliciete lokale variabele per iteratie om scope issues te voorkomen
                // De car.Id wordt gebruikt in de URL om naar de detailpagina te linken
                // Route: /car/{id:int} -> CarDetailModel.OnGetAsync(int id) -> GET /api/cars/{id}
                // Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt
                var carId = car.Id;
                
                <div class="col-md-6 col-lg-4 mb-4 car-card" 
                     data-budget="@car.Budget" 
                     data-fuel="@car.Fuel.ToLower()"
                     data-year="@car.Year"
                     data-car-id="@carId">
                    @* 
                        KAART COMPONENT - DYNAMISCHE ID DOORGEVEN:
                        ==========================================
                        FIXES TOEGEPAST:
                        1. Expliciete route constraint: /car/{id:int} in CarDetail.cshtml
                        2. Data attribute toegevoegd voor JavaScript fallback
                        3. Meerdere link methoden (onclick + href) voor betere compatibiliteit
                        4. Expliciete Razor interpolation met haakjes: @(carId)
                        5. Null-safe checks toegevoegd
                        
                        - De kaart is klikbaar en navigeert naar /car/{carId} waar {carId} de unieke ID is
                        - carId wordt per iteratie opnieuw geëxtraheerd uit car.Id
                        - Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt
                    *@
                    <div class="card h-100 shadow-sm" 
                         style="cursor: pointer; transition: transform 0.2s;" 
                         onclick="navigateToCarDetail(@carId)" 
                         onmouseover="this.style.transform='scale(1.02)'" 
                         onmouseout="this.style.transform='scale(1)'">
                        @{
                            // Probeer eerst ImageUrl van API
                            var imageUrl = !string.IsNullOrEmpty(car.ImageUrl) 
                                ? car.ImageUrl 
                                : string.Empty;
                            
                            // Als geen ImageUrl, probeer Auto-Data.net URL
                            if (string.IsNullOrEmpty(imageUrl))
                            {
                                var safeBrand = car.Brand?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                                var safeModel = car.Model?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                                imageUrl = $"https://www.auto-data.net/images/{safeBrand}/{safeModel}.jpg";
                            }
                            
                            // Fallback naar placeholder met merk en model tekst
                            var fallbackUrl = $"https://via.placeholder.com/400x300/0066CC/FFFFFF.png?text={Uri.EscapeDataString(car.Brand + " " + car.Model)}";
                        }
                        <img src="@imageUrl" 
                             class="card-img-top" 
                             alt="@car.Brand @car.Model"
                             style="height: 200px; object-fit: cover; background-color: #1a1a1a; display: block; width: 100%;"
                             onerror="if (this.src !== '@fallbackUrl') { this.src = '@fallbackUrl'; this.onerror = null; }"
                             loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/car/@carId" 
                                   class="text-decoration-none text-dark" 
                                   onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                                   data-car-id="@carId">
                                    @car.Brand @car.Model
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @car.Fuel<br>
                                <strong>Bouwjaar:</strong> @car.Year<br>
                                <strong>Vermogen:</strong> @ConvertKwToHp(car.Power) PK<br>
                                <strong>Transmissie:</strong> @FormatTransmission(car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @car.BodyType<br>
                                }
                            </p>
                            <a href="/car/@carId" 
                               class="btn btn-primary btn-sm w-100" 
                               onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                               data-car-id="@carId">
                                Bekijk details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <p class="text-muted">
                    <span id="filteredCount">@Model.AllCars.Count</span> van @Model.AllCars.Count auto's getoond
                </p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // FIX: JavaScript functie voor dynamische routing met validatie
        function navigateToCarDetail(carId) {
            // FIX: Expliciete validatie en logging voor debugging
            // Let op: carId kan 0 zijn in sommige systemen, maar we checken alleen op null/undefined
            if (carId == null || carId === undefined || isNaN(carId)) {
                console.error('Invalid carId:', carId);
                return;
            }
            
            // FIX: Expliciete URL constructie met validatie
            const url = '/car/' + parseInt(carId, 10);
            console.log('Navigating to car detail:', url, 'for carId:', carId);
            
            // Navigeer naar detailpagina
            window.location.href = url;
        }
        
        // FIX: Event listener voor data-car-id fallback (als onclick niet werkt)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-car-id]').forEach(function(element) {
                // Alleen toevoegen als er nog geen onclick handler is
                if (!element.onclick) {
                    element.addEventListener('click', function(e) {
                        const carId = parseInt(this.getAttribute('data-car-id'), 10);
                        if (!isNaN(carId)) {
                            navigateToCarDetail(carId);
                        }
                    });
                }
            });
        });
        
        const cars = @Html.Raw(Json.Serialize(Model.AllCars ?? new List<CarRecommender.Web.Models.Car>()));
        
        document.getElementById('maxBudget').addEventListener('input', function() {
            document.getElementById('budgetValue').textContent = parseInt(this.value).toLocaleString('nl-NL');
            filterCars();
        });

        document.getElementById('fuelFilter').addEventListener('change', filterCars);
        document.getElementById('minYear').addEventListener('input', function() {
            document.getElementById('yearValue').textContent = this.value;
            filterCars();
        });

        function filterCars() {
            const maxBudget = parseInt(document.getElementById('maxBudget').value);
            const fuelFilter = document.getElementById('fuelFilter').value.toLowerCase();
            const minYear = parseInt(document.getElementById('minYear').value);
            
            const carCards = document.querySelectorAll('.car-card');
            let visibleCount = 0;
            
            carCards.forEach(card => {
                const budget = parseFloat(card.dataset.budget);
                const fuel = card.dataset.fuel;
                const year = parseInt(card.dataset.year);
                
                const matchesBudget = budget <= maxBudget;
                const matchesFuel = !fuelFilter || fuel === fuelFilter;
                const matchesYear = year >= minYear;
                
                if (matchesBudget && matchesFuel && matchesYear) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            document.getElementById('filteredCount').textContent = visibleCount;
        }

        function resetFilters() {
            document.getElementById('maxBudget').value = document.getElementById('maxBudget').max;
            document.getElementById('budgetValue').textContent = parseInt(document.getElementById('maxBudget').max).toLocaleString('nl-NL');
            document.getElementById('fuelFilter').value = '';
            document.getElementById('minYear').value = document.getElementById('minYear').min;
            document.getElementById('yearValue').textContent = document.getElementById('minYear').min;
            filterCars();
        }
    </script>
}

