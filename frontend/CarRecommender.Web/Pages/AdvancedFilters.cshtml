@page "/advanced-filters"
@model AdvancedFiltersModel
@{
    ViewData["Title"] = "Geavanceerde Filters";
}

@*
    MANUELE FILTERS MODUS - VERSCHIL MET TEKST MODUS:
    ==================================================
    
    TEKST MODUS (Index.cshtml):
    - Gebruiker beschrijft wensen in vrije tekst
    - TextParserService parseert tekst naar UserPreferences
    - Endpoint: POST /api/recommendations/text
    
    MANUELE MODUS (AdvancedFilters.cshtml):
    - Gebruiker geeft expliciet alle filters op via formulier
    - Geen tekst parsing, directe mapping naar ManualFilterRequest
    - Endpoint: POST /api/recommendations/hybrid/manual
    - Alle velden zijn optioneel (null = geen filter)
    - Geen km-stand ondersteund (zoals gevraagd)
*@

<style>
    :root {
        --deep-purple: #4A148C;
        --purple-dark: #311B92;
        --purple-light: #7B1FA2;
        --purple-accent: #9C27B0;
    }

    .hero-header {
        background: linear-gradient(135deg, #000000 0%, var(--deep-purple) 50%, var(--purple-dark) 100%);
        color: white;
        padding: 4rem 0;
        margin: -1rem -15px 3rem -15px;
        border-radius: 0 0 30px 30px;
    }

    .hero-header h1 {
        font-size: 3rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .hero-header .lead {
        font-size: 1.3rem;
        opacity: 0.95;
    }

    .filter-form-container {
        max-width: 1400px;
        margin: 0 auto 3rem auto;
        padding: 0;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        border-left: 5px solid var(--deep-purple);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        padding: 1.5rem;
    }

    .card-header h5 {
        font-weight: 600;
        font-size: 1.5rem;
    }

    .card-body {
        padding: 2.5rem;
    }

    .form-label {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--deep-purple);
        box-shadow: 0 0 0 0.2rem rgba(74, 20, 140, 0.25);
        outline: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(74, 20, 140, 0.3);
        background: linear-gradient(135deg, var(--purple-dark) 0%, var(--deep-purple) 100%);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #424242 0%, #616161 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(66, 66, 66, 0.3);
        background: linear-gradient(135deg, #212121 0%, #424242 100%);
    }

    .alert-info {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border: none;
        border-left: 4px solid var(--deep-purple);
        color: #333;
        border-radius: 8px;
        padding: 1rem 1.5rem;
    }

    .alert-info strong {
        color: var(--deep-purple);
    }

    .alert-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: none;
        border-left: 4px solid #d32f2f;
        color: #333;
        border-radius: 8px;
        padding: 1rem 1.5rem;
    }

    .results-header {
        max-width: 1400px;
        margin: 0 auto 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        border-left: 5px solid var(--deep-purple);
    }

    .results-header h2 {
        color: var(--deep-purple);
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
    }

    .results-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        transition: transform 0.2s, box-shadow 0.3s;
        overflow: hidden;
    }

    .results-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(74, 20, 140, 0.2);
    }

    .card-title {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .card-title a {
        color: var(--deep-purple);
        text-decoration: none;
        transition: color 0.2s;
    }

    .card-title a:hover {
        color: var(--purple-accent);
    }

    .card-text {
        line-height: 1.8;
        color: #333;
    }

    .card-text strong {
        color: var(--deep-purple);
    }

    .btn-sm {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        font-weight: 600;
        padding: 0.5rem 1rem;
        transition: transform 0.2s;
    }

    .btn-sm:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, var(--purple-dark) 0%, var(--deep-purple) 100%);
    }

    .car-image-container {
        height: 200px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .results-grid {
        max-width: 1400px;
        margin: 0 auto;
    }

    .info-box {
        max-width: 1400px;
        margin: 0 auto 2rem auto;
    }

    @@media (max-width: 992px) {
        .hero-header h1 {
            font-size: 2rem;
        }
        
        .hero-header .lead {
            font-size: 1.1rem;
        }
    }
</style>

<div class="hero-header">
    <div class="container-fluid">
        <div class="text-center">
            <h1>Geavanceerde Filters</h1>
            <p class="lead">Stel zelf alle filters in zonder tekst parsing - <strong>Manuele Filters Modus</strong></p>
        </div>
    </div>
</div>

<div class="container-fluid" style="max-width: 1400px; padding: 0 2rem;">
    <div class="info-box">
        <div class="alert alert-info">
            <strong>Let op:</strong> Dit is de manuele filters modus. Alle velden zijn optioneel. 
            Stel ten minste één filter in om te zoeken.
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 2rem;">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="filter-form-container">
        <form method="post" class="mb-4">
            <div class="card">
                <div class="card-header text-white">
                    <h5 class="mb-0">Filter Instellingen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Prijs Range -->
                        <div class="col-md-6 mb-3">
                            <label for="MinPrice" class="form-label">Minimum Prijs (€)</label>
                            <input type="number" class="form-control" id="MinPrice" name="FilterRequest.MinPrice" 
                                   value="@Model.FilterRequest?.MinPrice" min="0" step="100" placeholder="Bijv. 10000">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="MaxPrice" class="form-label">Maximum Prijs (€)</label>
                            <input type="number" class="form-control" id="MaxPrice" name="FilterRequest.MaxPrice" 
                                   value="@Model.FilterRequest?.MaxPrice" min="0" step="100" placeholder="Bijv. 30000">
                        </div>

                        <!-- Merk en Model -->
                        <div class="col-md-6 mb-3">
                            <label for="Brand" class="form-label">Merk</label>
                            <select class="form-select" id="Brand" name="FilterRequest.Brand">
                                @foreach (var brand in Model.Brands)
                                {
                                    <option value="@(brand == "" ? "" : brand.ToLower())" 
                                            selected="@(Model.FilterRequest?.Brand?.ToLower() == brand.ToLower())">
                                        @(brand == "" ? "-- Selecteer merk --" : brand)
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="Model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="Model" name="FilterRequest.Model" 
                                   value="@Model.FilterRequest?.Model" placeholder="Bijv. X5, A4">
                        </div>

                        <!-- Brandstof en Transmissie -->
                        <div class="col-md-6 mb-3">
                            <label for="Fuel" class="form-label">Brandstof</label>
                            <select class="form-select" id="Fuel" name="FilterRequest.Fuel">
                                @foreach (var fuel in Model.FuelTypes)
                                {
                                    <option value="@(fuel == "" ? "" : fuel)" 
                                            selected="@(Model.FilterRequest?.Fuel == fuel)">
                                        @(fuel == "" ? "-- Selecteer brandstof --" : 
                                            fuel == "petrol" ? "Benzine" :
                                            fuel == "diesel" ? "Diesel" :
                                            fuel == "hybrid" ? "Hybride" :
                                            fuel == "electric" ? "Elektrisch" : fuel)
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="TransmissionString" class="form-label">Transmissie</label>
                            <select class="form-select" id="TransmissionString" name="TransmissionString">
                                <option value="">-- Selecteer transmissie --</option>
                                <option value="Automaat" selected="@(Model.FilterRequest?.Transmission == true)">Automaat</option>
                                <option value="Schakel" selected="@(Model.FilterRequest?.Transmission == false)">Schakel</option>
                            </select>
                        </div>

                        <!-- Carrosserie -->
                        <div class="col-md-6 mb-3">
                            <label for="BodyType" class="form-label">Carrosserie</label>
                            <select class="form-select" id="BodyType" name="FilterRequest.BodyType">
                                @foreach (var bodyType in Model.BodyTypes)
                                {
                                    <option value="@(bodyType == "" ? "" : bodyType)" 
                                            selected="@(Model.FilterRequest?.BodyType == bodyType)">
                                        @(bodyType == "" ? "-- Selecteer carrosserie --" : 
                                            bodyType == "suv" ? "SUV" :
                                            bodyType == "sedan" ? "Sedan" :
                                            bodyType == "hatchback" ? "Hatchback" :
                                            bodyType == "station" ? "Station" :
                                            bodyType == "cabrio" ? "Cabrio" :
                                            bodyType == "coupe" ? "Coupé" : bodyType)
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Bouwjaar Range -->
                        <div class="col-md-3 mb-3">
                            <label for="MinYear" class="form-label">Minimum Bouwjaar</label>
                            <input type="number" class="form-control" id="MinYear" name="FilterRequest.MinYear" 
                                   value="@Model.FilterRequest?.MinYear" min="1900" max="@DateTime.Now.Year" 
                                   placeholder="Bijv. 2015">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="MaxYear" class="form-label">Maximum Bouwjaar</label>
                            <input type="number" class="form-control" id="MaxYear" name="FilterRequest.MaxYear" 
                                   value="@Model.FilterRequest?.MaxYear" min="1900" max="@DateTime.Now.Year" 
                                   placeholder="Bijv. 2023">
                        </div>

                        <!-- Minimum Vermogen -->
                        <div class="col-md-6 mb-3">
                            <label for="MinPower" class="form-label">Minimum Vermogen (KW)</label>
                            <input type="number" class="form-control" id="MinPower" name="FilterRequest.MinPower" 
                                   value="@Model.FilterRequest?.MinPower" min="0" step="10" placeholder="Bijv. 150">
                        </div>

                        <!-- Aantal Resultaten -->
                        <div class="col-md-6 mb-3">
                            <label for="Top" class="form-label">Aantal Resultaten</label>
                            <input type="number" class="form-control" id="Top" name="FilterRequest.Top" 
                                   value="@(Model.FilterRequest?.Top ?? 5)" min="1" max="20" step="1">
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-search"></i> Zoek met Manuele Filters
                        </button>
                        <a href="/" class="btn btn-secondary btn-lg ms-2">
                            <i class="bi bi-arrow-left"></i> Terug naar Tekst Modus
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    @if (Model.Recommendations != null && Model.Recommendations.Count > 0)
    {
        <div class="results-header">
            <h2>Aanbevolen auto's (Manuele Filters Modus)</h2>
        </div>

        <div class="row results-grid">
            @foreach (var recommendation in Model.Recommendations)
            {
                // DYNAMISCHE ROUTING: Elke auto-kaart gebruikt zijn eigen unieke ID
                // FIX: Expliciete lokale variabele per iteratie om scope issues te voorkomen
                // De carId variabele wordt geëxtraheerd uit recommendation.Car.Id en gebruikt in de URL
                // Route: /car/{id:int} -> CarDetailModel.OnGetAsync(int id) -> GET /api/cars/{id}
                // Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt (geen hardcoded ID meer)
                // FIX: Check eerst of Car niet null is (belangrijker dan ID check)
                if (recommendation?.Car == null)
                {
                    continue; // Skip null recommendations
                }
                
                var carId = recommendation.Car.Id;
                var carBrand = recommendation.Car.Brand ?? "";
                var carModel = recommendation.Car.Model ?? "";
                var imageUrl = Model.GetCarImageUrl(recommendation.Car.ImageUrl, carBrand, carModel, carId);
                
                <div class="col-md-6 col-lg-4 mb-4">
                    @* 
                        KAART COMPONENT - DYNAMISCHE ID DOORGEVEN:
                        ==========================================
                        FIXES TOEGEPAST:
                        1. Expliciete route constraint: /car/{id:int} in CarDetail.cshtml
                        2. Data attribute toegevoegd voor JavaScript fallback
                        3. Meerdere link methoden (onclick + href) voor betere compatibiliteit
                        4. Expliciete Razor interpolation met haakjes: @(carId)
                        5. Null-safe checks toegevoegd
                        
                        - onclick: Navigeert naar /car/{carId} waar {carId} de unieke ID is van deze specifieke auto
                        - href links: Alle links in de kaart gebruiken /car/@carId om naar de detailpagina te gaan
                        - carId wordt per iteratie opnieuw geëxtraheerd uit recommendation.Car.Id
                        - Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt
                    *@
                    <div class="results-card h-100" 
                         style="cursor: pointer;" 
                         data-car-id="@carId"
                         onclick="navigateToCarDetail(@carId)">
                        <div class="car-image-container">
                            @if (!string.IsNullOrEmpty(imageUrl))
                            {
                                <img src="@imageUrl" 
                                     class="card-img-top" 
                                     alt="@carBrand @carModel"
                                     style="height: 100%; width: 100%; object-fit: cover; position: absolute; top: 0; left: 0;"
                                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                     loading="lazy">
                            }
                            <div style="display: @(string.IsNullOrEmpty(imageUrl) ? "flex" : "none"); flex-direction: column; align-items: center; justify-content: center; color: #fff; padding: 20px; text-align: center; width: 100%; height: 100%;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 10px; opacity: 0.7;">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z" fill="currentColor"/>
                                </svg>
                                <div style="font-size: 14px; font-weight: bold; margin-top: 5px;">@carBrand</div>
                                <div style="font-size: 12px; opacity: 0.8;">@carModel</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/car/@carId" 
                                   onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                                   data-car-id="@carId">
                                    @carBrand @carModel
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@recommendation.Car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @recommendation.Car.Fuel<br>
                                <strong>Bouwjaar:</strong> @recommendation.Car.Year<br>
                                <strong>Vermogen:</strong> @Model.ConvertKwToHp(recommendation.Car.Power) PK<br>
                                <strong>Transmissie:</strong> @Model.FormatTransmission(recommendation.Car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(recommendation.Car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @recommendation.Car.BodyType<br>
                                }
                                <strong>Match:</strong> @((recommendation.SimilarityScore * 100).ToString("F1"))%
                            </p>
                            <div class="alert alert-info mb-2">
                                <small><strong>Waarom deze auto?</strong><br>@recommendation.Explanation</small>
                            </div>
                            <a href="/car/@carId" 
                               class="btn btn-primary btn-sm w-100" 
                               onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                               data-car-id="@carId">
                                Bekijk alle foto's
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* 
    JAVASCRIPT FALLBACK - Zorgt ervoor dat routing altijd werkt:
    =============================================================
    - Functie navigateToCarDetail gebruikt expliciet de doorgegeven ID
    - Werkt als fallback als Razor interpolation faalt
    - Gebruikt data-car-id attribute als backup
*@
<script>
    function navigateToCarDetail(carId) {
        // FIX: Expliciete validatie en logging voor debugging
        // Let op: carId kan 0 zijn in sommige systemen, maar we checken alleen op null/undefined
        if (carId == null || carId === undefined || isNaN(carId)) {
            console.error('Invalid carId:', carId);
            return;
        }
    
        // FIX: Expliciete URL constructie met validatie
        const url = '/car/' + parseInt(carId, 10);
        console.log('Navigating to car detail:', url, 'for carId:', carId);
        
        // Navigeer naar detailpagina
        window.location.href = url;
    }
    
    // FIX: Event listener voor data-car-id fallback (als onclick niet werkt)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-car-id]').forEach(function(element) {
            // Alleen toevoegen als er nog geen onclick handler is
            if (!element.onclick) {
                element.addEventListener('click', function(e) {
                    const carId = parseInt(this.getAttribute('data-car-id'), 10);
                    if (carId > 0) {
                        navigateToCarDetail(carId);
                    }
                });
            }
        });
    });
</script>