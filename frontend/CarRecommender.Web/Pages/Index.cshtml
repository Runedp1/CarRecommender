@page "/text-search"
@model IndexModel
@{
    ViewData["Title"] = "Tekst Zoeken";
}

@*
    BUG FIXES GESCHIEDENIS:
    ========================
    
    PROBLEEM 1: Alle kaarten toonden dezelfde afbeelding
    OORZAAK: Razor variabelen (imageUrl, fallbackUrl) werden mogelijk hergebruikt tussen foreach iteraties,
            of de ImageUrl property was leeg/hetzelfde voor alle auto's, waardoor alle kaarten dezelfde
            fallback URL gebruikten.
    OPLOSSING: 
    - Expliciete lokale variabelen (carId, carBrand, carModel) per iteratie om uniekheid te garanderen
    - Image URL generatie gebeurt nu expliciet per auto met unieke fallback op basis van merk + model
    - Variabelen worden binnen de foreach loop gedeclareerd om scoping issues te voorkomen
    
    PROBLEEM 2: Alle links gingen naar dezelfde detailpagina (bmw x5)
    OORZAAK: Mogelijk dat recommendation.Car.Id dezelfde waarde had voor alle recommendations, of
            Razor was niet correct de ID waarde aan het interpoleren in de href/onclick attributen.
    OPLOSSING:
    - Expliciete carId variabele per iteratie
    - Gebruik van carId variabele in plaats van recommendation.Car.Id in alle href en onclick attributen
    - Dit garandeert dat elke kaart naar de juiste detailpagina linkt
    
    BESTANDEN AANGEPAST:
    - frontend/CarRecommender.Web/Pages/Index.cshtml
*@

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        // Normaliseer naar Nederlandse termen
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        // Als het niet herkend wordt, retourneer de originele waarde met hoofdletter
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
    
    /// <summary>
    /// Converteert vermogen van KW naar PK (paardenkracht).
    /// Dataset bevat vermogen in KW, maar we tonen het in PK voor gebruikers.
    /// Conversie: 1 KW = 1.35962 PK (afgerond naar 1.36)
    /// </summary>
    int ConvertKwToHp(int powerKw)
    {
        // 1 KW = 1.35962 PK (metrische paardenkracht)
        // Afgerond naar 1.36 voor eenvoud
        return (int)Math.Round(powerKw * 1.35962);
    }

    /// <summary>
    /// Formatteert body type naar Nederlandse termen met hoofdletters.
    /// </summary>
    string FormatBodyType(string? bodyType)
    {
        if (string.IsNullOrWhiteSpace(bodyType))
            return "Niet opgegeven";
        
        string lower = bodyType.ToLower().Trim();
        
        // Map naar Nederlandse termen met hoofdletters
        return lower switch
        {
            "suv" => "SUV",
            "sedan" => "Sedan",
            "hatchback" => "Hatchback",
            "station" => "Station",
            "cabrio" => "Cabrio",
            "coupe" => "Coupé",
            "wagon" => "Station",
            "convertible" => "Cabrio",
            _ => char.ToUpper(bodyType[0]) + (bodyType.Length > 1 ? bodyType.Substring(1).ToLower() : "")
        };
    }
}

<style>
    :root {
        --deep-purple: #4A148C;
        --purple-dark: #311B92;
        --purple-light: #7B1FA2;
        --purple-accent: #9C27B0;
    }

    .hero-header {
        background: linear-gradient(135deg, #000000 0%, var(--deep-purple) 50%, var(--purple-dark) 100%);
        color: white;
        padding: 4rem 0;
        margin: -1rem -15px 3rem -15px;
        border-radius: 0 0 30px 30px;
    }

    .hero-header h1 {
        font-size: 3rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .hero-header .lead {
        font-size: 1.3rem;
        opacity: 0.95;
    }

    .search-section {
        max-width: 1400px;
        margin: 0 auto 3rem auto;
        padding: 2.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        border-left: 5px solid var(--deep-purple);
    }

    .search-section label {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }

    .search-section textarea {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        font-size: 1.05rem;
        transition: border-color 0.3s;
    }

    .search-section textarea:focus {
        border-color: var(--deep-purple);
        box-shadow: 0 0 0 0.2rem rgba(74, 20, 140, 0.25);
        outline: none;
    }

    .form-text {
        color: #666;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(74, 20, 140, 0.3);
        background: linear-gradient(135deg, var(--purple-dark) 0%, var(--deep-purple) 100%);
    }

    .results-header {
        max-width: 1400px;
        margin: 0 auto 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        border-left: 5px solid var(--deep-purple);
    }

    .results-header h2 {
        color: var(--deep-purple);
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        transition: transform 0.2s, box-shadow 0.3s;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(74, 20, 140, 0.2);
    }

    .card-title {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .card-title a {
        color: var(--deep-purple);
        text-decoration: none;
        transition: color 0.2s;
    }

    .card-title a:hover {
        color: var(--purple-accent);
    }

    .card-text {
        line-height: 1.8;
        color: #333;
    }

    .card-text strong {
        color: var(--deep-purple);
    }

    .alert-info {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border: none;
        border-left: 4px solid var(--deep-purple);
        color: #333;
    }

    .alert-info strong {
        color: var(--deep-purple);
    }

    .alert-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: none;
        border-left: 4px solid #d32f2f;
        color: #333;
    }

    .btn-sm {
        background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%);
        border: none;
        font-weight: 600;
        padding: 0.5rem 1rem;
        transition: transform 0.2s;
    }

    .btn-sm:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, var(--purple-dark) 0%, var(--deep-purple) 100%);
    }

    .car-image-container {
        height: 200px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .results-grid {
        max-width: 1400px;
        margin: 0 auto;
    }

    @@media (max-width: 992px) {
        .hero-header h1 {
            font-size: 2rem;
        }
        
        .hero-header .lead {
            font-size: 1.1rem;
        }
    }
</style>

<div class="hero-header">
    <div class="container-fluid">
        <div class="text-center">
            <h1>Tekst Zoeken</h1>
            <p class="lead">Beschrijf uw wensen in vrije tekst en wij vinden de perfecte auto voor u!</p>
        </div>
    </div>
</div>

<div class="container-fluid" style="max-width: 1400px; padding: 0 2rem;">
    <div class="info-box" style="max-width: 1400px; margin: 0 auto 2rem auto;">
        <div class="alert alert-info">
            <strong>Tip:</strong> Beschrijf uw voorkeuren in vrije tekst. 
            Gebruik <a href="/" class="alert-link">Geavanceerde Filters</a> voor een gedetailleerde zoekopdracht met dropdowns.
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 2rem;">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="search-section">
        <form method="post">
            <div class="mb-3">
                <label for="SearchText" class="form-label">Beschrijf uw ideale auto:</label>
                <textarea 
                    class="form-control" 
                    id="SearchText" 
                    name="SearchText" 
                    rows="4" 
                    placeholder="Bijvoorbeeld: BMW, maximaal 25.000 euro budget, benzine, automaat, minstens 200pk"
                    required>@Model.SearchText</textarea>
                <div class="form-text">
                    Beschrijf uw voorkeuren: maximum en/of minimum budget, brandstof, transmissie, carrosserie (bv. suv, hatchback), vermogen (PK), etc.
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-search"></i> Zoek mijn ideale auto
            </button>
        </form>
    </div>

    @if (Model.Recommendations != null && Model.Recommendations.Count > 0)
    {
        <div class="results-header">
            <h2>Aanbevolen auto's</h2>
        </div>

        <div class="row results-grid">
            @foreach (var recommendation in Model.Recommendations)
            {
                // DYNAMISCHE ROUTING: Elke auto-kaart gebruikt zijn eigen unieke ID
                // FIX: Expliciete lokale variabele per iteratie om scope issues te voorkomen
                // De carId variabele wordt geëxtraheerd uit recommendation.Car.Id en gebruikt in de URL
                // Route: /car/{id:int} -> CarDetailModel.OnGetAsync(int id) -> GET /api/cars/{id}
                // Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt (geen hardcoded ID meer)
                // FIX: Check eerst of Car niet null is (belangrijker dan ID check)
                if (recommendation?.Car == null)
                {
                    continue; // Skip null recommendations
                }
                
                var carId = recommendation.Car.Id;
                var carBrand = recommendation.Car.Brand ?? "";
                var carModel = recommendation.Car.Model ?? "";
                var imageUrl = Model.GetCarImageUrl(recommendation.Car.ImageUrl, carBrand, carModel, carId);
                
                <div class="col-md-6 col-lg-4 mb-4">
                    @* 
                        KAART COMPONENT - DYNAMISCHE ID DOORGEVEN:
                        ==========================================
                        FIXES TOEGEPAST:
                        1. Expliciete route constraint: /car/{id:int} in CarDetail.cshtml
                        2. Data attribute toegevoegd voor JavaScript fallback
                        3. Meerdere link methoden (onclick + href) voor betere compatibiliteit
                        4. Expliciete Razor interpolation met haakjes: @(carId)
                        5. Null-safe checks toegevoegd
                        
                        - onclick: Navigeert naar /car/{carId} waar {carId} de unieke ID is van deze specifieke auto
                        - href links: Alle links in de kaart gebruiken /car/@carId om naar de detailpagina te gaan
                        - carId wordt per iteratie opnieuw geëxtraheerd uit recommendation.Car.Id
                        - Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt
                    *@
                    <div class="card h-100" 
                         style="cursor: pointer;" 
                         data-car-id="@carId"
                         onclick="navigateToCarDetail(@carId);">
                        <div class="car-image-container">
                            @if (!string.IsNullOrEmpty(imageUrl))
                            {
                                <img src="@imageUrl" 
                                     class="card-img-top" 
                                     alt="@carBrand @carModel"
                                     style="height: 100%; width: 100%; object-fit: cover; position: absolute; top: 0; left: 0;"
                                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                     loading="lazy">
                            }
                            <div style="display: @(string.IsNullOrEmpty(imageUrl) ? "flex" : "none"); flex-direction: column; align-items: center; justify-content: center; color: #fff; padding: 20px; text-align: center; width: 100%; height: 100%;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 10px; opacity: 0.7;">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z" fill="currentColor"/>
                                </svg>
                                <div style="font-size: 14px; font-weight: bold; margin-top: 5px;">@carBrand</div>
                                <div style="font-size: 12px; opacity: 0.8;">@carModel</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/car/@carId" 
                                   onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                                   data-car-id="@carId">
                                    @carBrand @carModel
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@recommendation.Car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @recommendation.Car.Fuel<br>
                                <strong>Bouwjaar:</strong> @recommendation.Car.Year<br>
                                <strong>Vermogen:</strong> @ConvertKwToHp(recommendation.Car.Power) PK<br>
                                <strong>Transmissie:</strong> @FormatTransmission(recommendation.Car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(recommendation.Car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @FormatBodyType(recommendation.Car.BodyType)<br>
                                }
                                <strong>Match:</strong> @((recommendation.SimilarityScore * 100).ToString("F1"))%
                            </p>
                            <div class="alert alert-info mb-2">
                                <small><strong>Waarom deze auto?</strong><br>@recommendation.Explanation</small>
                            </div>
                            <a href="/car/@carId" 
                               class="btn btn-primary btn-sm w-100" 
                               onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                               data-car-id="@carId">
                                Bekijk alle foto's
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* 
    JAVASCRIPT FALLBACK - Zorgt ervoor dat routing altijd werkt:
    =============================================================
    - Functie navigateToCarDetail gebruikt expliciet de doorgegeven ID
    - Werkt als fallback als Razor interpolation faalt
    - Gebruikt data-car-id attribute als backup
*@
<script>
    function navigateToCarDetail(carId) {
        // Validatie: check of carId geldig is
        if (carId == null || carId === undefined || isNaN(carId)) {
            console.error('Invalid carId:', carId);
            return;
        }
        
        // Navigeer naar detailpagina
        const url = '/car/' + parseInt(carId, 10);
        window.location.href = url;
    }

    // FIX: Event listener voor data-car-id fallback (als onclick niet werkt)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-car-id]').forEach(function(element) {
            // Alleen toevoegen als er nog geen onclick handler is
            if (!element.onclick) {
                element.addEventListener('click', function(e) {
                    const carId = parseInt(this.getAttribute('data-car-id'), 10);
                    if (carId > 0) {
                        navigateToCarDetail(carId);
                    }
                });
            }
        });
    });
</script>