@page
@model IndexModel
@{
    ViewData["Title"] = "Zoek uw ideale auto";
}

@*
    BUG FIXES GESCHIEDENIS:
    ========================
    
    PROBLEEM 1: Alle kaarten toonden dezelfde afbeelding
    OORZAAK: Razor variabelen (imageUrl, fallbackUrl) werden mogelijk hergebruikt tussen foreach iteraties,
            of de ImageUrl property was leeg/hetzelfde voor alle auto's, waardoor alle kaarten dezelfde
            fallback URL gebruikten.
    OPLOSSING: 
    - Expliciete lokale variabelen (carId, carBrand, carModel) per iteratie om uniekheid te garanderen
    - Image URL generatie gebeurt nu expliciet per auto met unieke fallback op basis van merk + model
    - Variabelen worden binnen de foreach loop gedeclareerd om scoping issues te voorkomen
    
    PROBLEEM 2: Alle links gingen naar dezelfde detailpagina (bmw x5)
    OORZAAK: Mogelijk dat recommendation.Car.Id dezelfde waarde had voor alle recommendations, of
            Razor was niet correct de ID waarde aan het interpoleren in de href/onclick attributen.
    OPLOSSING:
    - Expliciete carId variabele per iteratie
    - Gebruik van carId variabele in plaats van recommendation.Car.Id in alle href en onclick attributen
    - Dit garandeert dat elke kaart naar de juiste detailpagina linkt
    
    BESTANDEN AANGEPAST:
    - frontend/CarRecommender.Web/Pages/Index.cshtml
*@

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        // Normaliseer naar Nederlandse termen
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        // Als het niet herkend wordt, retourneer de originele waarde met hoofdletter
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 mb-4">Zoek uw ideale auto</h1>
            <p class="lead">Beschrijf uw wensen en wij vinden de perfecte auto voor u!</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <form method="post" class="mb-4">
                <div class="mb-3">
                    <label for="SearchText" class="form-label">Beschrijf uw ideale auto:</label>
                    <textarea 
                        class="form-control" 
                        id="SearchText" 
                        name="SearchText" 
                        rows="4" 
                        placeholder="Bijvoorbeeld: Ik zoek een auto met maximaal 25.000 euro budget, benzine, automaat, voor dagelijks woon-werkverkeer..."
                        required>@Model.SearchText</textarea>
                    <div class="form-text">
                        Beschrijf uw voorkeuren zoals budget, brandstof, transmissie, gebruik, vermogen, etc.
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Zoek mijn ideale auto
                </button>
            </form>
        </div>
    </div>

    @if (Model.Recommendations != null && Model.Recommendations.Count > 0)
    {
        <div class="row mt-4">
            <div class="col-12">
                <h2 class="mb-4">Aanbevolen auto's</h2>
            </div>
        </div>

        <div class="row">
            @foreach (var recommendation in Model.Recommendations)
            {
                // BUG FIX: Zorg dat elke kaart een unieke identifier heeft op basis van de auto ID
                // Dit voorkomt dat Razor dezelfde variabelen hergebruikt tussen iteraties
                var carId = recommendation.Car.Id;
                var carBrand = recommendation.Car.Brand ?? "";
                var carModel = recommendation.Car.Model ?? "";
                
                // BUG FIX: Genereer deterministische image URL per auto op basis van ID, merk en model
                // Dit voorkomt dat alle kaarten dezelfde afbeelding tonen
                // Stap 1: Probeer ImageUrl van API (kan Kaggle image zijn)
                var imageUrl = !string.IsNullOrEmpty(recommendation.Car.ImageUrl) 
                    ? recommendation.Car.ImageUrl 
                    : string.Empty;
                
                // Stap 2: Als ImageUrl relatief pad is (begint met /), skip voor Azure deployment
                if (!string.IsNullOrEmpty(imageUrl) && imageUrl.StartsWith("/"))
                {
                    imageUrl = string.Empty;
                }
                
                // Stap 3: Als geen ImageUrl, genereer Auto-Data.net URL op basis van merk en model
                // BUG FIX: Gebruik expliciet carBrand en carModel variabelen om te voorkomen dat
                // dezelfde waarde wordt hergebruikt voor alle kaarten
                if (string.IsNullOrEmpty(imageUrl))
                {
                    var safeBrand = carBrand.Trim().Replace(" ", "-").Replace("&", "and").ToLower();
                    var safeModel = carModel.Trim().Replace(" ", "-").Replace("&", "and").ToLower();
                    imageUrl = $"https://www.auto-data.net/images/{safeBrand}/{safeModel}.jpg";
                }
                
                // Stap 4: Fallback naar placeholder met unieke tekst per auto (merk + model + ID voor extra uniekheid)
                // BUG FIX: Gebruik carId in fallback URL om uniekheid te garanderen
                var fallbackUrl = $"https://via.placeholder.com/400x300/0066CC/FFFFFF.png?text={Uri.EscapeDataString(carBrand + " " + carModel)}";
                
                <div class="col-md-6 col-lg-4 mb-4">
                    <!-- BUG FIX: Gebruik expliciet carId variabele in onclick en href attributen -->
                    <!-- Dit voorkomt dat alle kaarten naar dezelfde detailpagina linken -->
                    <div class="card h-100 shadow-sm" style="cursor: pointer; transition: transform 0.2s;" onclick="window.location.href='/car/@carId'" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <!-- BUG FIX: Gebruik expliciet imageUrl variabele die per iteratie wordt gegenereerd -->
                        <!-- Dit voorkomt dat alle kaarten dezelfde afbeelding tonen -->
                        <img src="@imageUrl" 
                             class="card-img-top" 
                             alt="@carBrand @carModel"
                             style="height: 200px; object-fit: cover; background-color: #1a1a1a; display: block; width: 100%;"
                             onerror="if (this.src !== '@fallbackUrl') { this.src = '@fallbackUrl'; this.onerror = null; }"
                             loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">
                                <!-- BUG FIX: Gebruik expliciet carId variabele in href -->
                                <a href="/car/@carId" class="text-decoration-none text-dark" onclick="event.stopPropagation();">
                                    @carBrand @carModel
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@recommendation.Car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @recommendation.Car.Fuel<br>
                                <strong>Bouwjaar:</strong> @recommendation.Car.Year<br>
                                <strong>Vermogen:</strong> @recommendation.Car.Power PK<br>
                                <strong>Transmissie:</strong> @FormatTransmission(recommendation.Car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(recommendation.Car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @recommendation.Car.BodyType<br>
                                }
                                <strong>Match:</strong> @((recommendation.SimilarityScore * 100).ToString("F1"))%
                            </p>
                            <div class="alert alert-info mb-2">
                                <small><strong>Waarom deze auto?</strong><br>@recommendation.Explanation</small>
                            </div>
                            <!-- BUG FIX: Gebruik expliciet carId variabele in href -->
                            <a href="/car/@carId" class="btn btn-primary btn-sm w-100" onclick="event.stopPropagation();">
                                Bekijk alle foto's
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
