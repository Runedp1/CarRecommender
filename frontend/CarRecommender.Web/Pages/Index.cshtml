@page
@model IndexModel
@{
    ViewData["Title"] = "Zoek uw ideale auto";
}

@*
    BUG FIXES GESCHIEDENIS:
    ========================
    
    PROBLEEM 1: Alle kaarten toonden dezelfde afbeelding
    OORZAAK: Razor variabelen (imageUrl, fallbackUrl) werden mogelijk hergebruikt tussen foreach iteraties,
            of de ImageUrl property was leeg/hetzelfde voor alle auto's, waardoor alle kaarten dezelfde
            fallback URL gebruikten.
    OPLOSSING: 
    - Expliciete lokale variabelen (carId, carBrand, carModel) per iteratie om uniekheid te garanderen
    - Image URL generatie gebeurt nu expliciet per auto met unieke fallback op basis van merk + model
    - Variabelen worden binnen de foreach loop gedeclareerd om scoping issues te voorkomen
    
    PROBLEEM 2: Alle links gingen naar dezelfde detailpagina (bmw x5)
    OORZAAK: Mogelijk dat recommendation.Car.Id dezelfde waarde had voor alle recommendations, of
            Razor was niet correct de ID waarde aan het interpoleren in de href/onclick attributen.
    OPLOSSING:
    - Expliciete carId variabele per iteratie
    - Gebruik van carId variabele in plaats van recommendation.Car.Id in alle href en onclick attributen
    - Dit garandeert dat elke kaart naar de juiste detailpagina linkt
    
    BESTANDEN AANGEPAST:
    - frontend/CarRecommender.Web/Pages/Index.cshtml
*@

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        // Normaliseer naar Nederlandse termen
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        // Als het niet herkend wordt, retourneer de originele waarde met hoofdletter
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
    
    /// <summary>
    /// Converteert vermogen van KW naar PK (paardenkracht).
    /// Dataset bevat vermogen in KW, maar we tonen het in PK voor gebruikers.
    /// Conversie: 1 KW = 1.35962 PK (afgerond naar 1.36)
    /// </summary>
    int ConvertKwToHp(int powerKw)
    {
        // 1 KW = 1.35962 PK (metrische paardenkracht)
        // Afgerond naar 1.36 voor eenvoud
        return (int)Math.Round(powerKw * 1.35962);
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 mb-4">Zoek uw ideale auto</h1>
            <p class="lead">Beschrijf uw wensen en wij vinden de perfecte auto voor u!</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <form method="post" class="mb-4">
                <div class="mb-3">
                    <label for="SearchText" class="form-label">Beschrijf uw ideale auto:</label>
                    <textarea 
                        class="form-control" 
                        id="SearchText" 
                        name="SearchText" 
                        rows="4" 
                        placeholder="Bijvoorbeeld: Ik zoek een auto met maximaal 25.000 euro budget, benzine, automaat, voor dagelijks woon-werkverkeer..."
                        required>@Model.SearchText</textarea>
                    <div class="form-text">
                        Beschrijf uw voorkeuren zoals budget, brandstof, transmissie, gebruik, vermogen, etc.
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Zoek mijn ideale auto
                </button>
            </form>
        </div>
    </div>

    @if (Model.Recommendations != null && Model.Recommendations.Count > 0)
    {
        <div class="row mt-4">
            <div class="col-12">
                <h2 class="mb-4">Aanbevolen auto's</h2>
            </div>
        </div>

        <div class="row">
            @foreach (var recommendation in Model.Recommendations)
            {
                // DYNAMISCHE ROUTING: Elke auto-kaart gebruikt zijn eigen unieke ID
                // FIX: Expliciete lokale variabele per iteratie om scope issues te voorkomen
                // De carId variabele wordt geëxtraheerd uit recommendation.Car.Id en gebruikt in de URL
                // Route: /car/{id:int} -> CarDetailModel.OnGetAsync(int id) -> GET /api/cars/{id}
                // Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt (geen hardcoded ID meer)
                // FIX: Check eerst of Car niet null is (belangrijker dan ID check)
                if (recommendation?.Car == null)
                {
                    continue; // Skip null recommendations
                }
                
                var carId = recommendation.Car.Id;
                var carBrand = recommendation.Car.Brand ?? "";
                var carModel = recommendation.Car.Model ?? "";
                var imageUrl = Model.GetCarImageUrl(recommendation.Car.ImageUrl, carBrand, carModel, carId);
                
                <div class="col-md-6 col-lg-4 mb-4">
                    @* 
                        KAART COMPONENT - DYNAMISCHE ID DOORGEVEN:
                        ==========================================
                        FIXES TOEGEPAST:
                        1. Expliciete route constraint: /car/{id:int} in CarDetail.cshtml
                        2. Data attribute toegevoegd voor JavaScript fallback
                        3. Meerdere link methoden (onclick + href) voor betere compatibiliteit
                        4. Expliciete Razor interpolation met haakjes: @(carId)
                        5. Null-safe checks toegevoegd
                        
                        - onclick: Navigeert naar /car/{carId} waar {carId} de unieke ID is van deze specifieke auto
                        - href links: Alle links in de kaart gebruiken /car/@carId om naar de detailpagina te gaan
                        - carId wordt per iteratie opnieuw geëxtraheerd uit recommendation.Car.Id
                        - Dit zorgt ervoor dat elke kaart naar zijn eigen detailpagina linkt
                    *@
                    <div class="card h-100 shadow-sm" 
                         style="cursor: pointer; transition: transform 0.2s;" 
                         data-car-id="@carId"
                         onclick="navigateToCarDetail(@carId);" 
                         onmouseover="this.style.transform='scale(1.02)'" 
                         onmouseout="this.style.transform='scale(1)'">
                        <div style="height: 200px; background-color: #1a1a1a; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                            @if (!string.IsNullOrEmpty(imageUrl))
                            {
                                <img src="@imageUrl" 
                                     class="card-img-top" 
                                     alt="@carBrand @carModel"
                                     style="height: 100%; width: 100%; object-fit: cover; position: absolute; top: 0; left: 0;"
                                     onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                     loading="lazy">
                            }
                            <div style="display: @(string.IsNullOrEmpty(imageUrl) ? "flex" : "none"); flex-direction: column; align-items: center; justify-content: center; color: #fff; padding: 20px; text-align: center; width: 100%; height: 100%;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 10px; opacity: 0.7;">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z" fill="currentColor"/>
                                </svg>
                                <div style="font-size: 14px; font-weight: bold; margin-top: 5px;">@carBrand</div>
                                <div style="font-size: 12px; opacity: 0.8;">@carModel</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="/car/@carId" 
                                   class="text-decoration-none text-dark" 
                                   onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                                   data-car-id="@carId">
                                    @carBrand @carModel
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>Prijs:</strong> €@recommendation.Car.Budget.ToString("N0")<br>
                                <strong>Brandstof:</strong> @recommendation.Car.Fuel<br>
                                <strong>Bouwjaar:</strong> @recommendation.Car.Year<br>
                                <strong>Vermogen:</strong> @ConvertKwToHp(recommendation.Car.Power) PK<br>
                                <strong>Transmissie:</strong> @FormatTransmission(recommendation.Car.Transmission)<br>
                                @if (!string.IsNullOrWhiteSpace(recommendation.Car.BodyType))
                                {
                                    <strong>Carrosserie:</strong> @recommendation.Car.BodyType<br>
                                }
                                <strong>Match:</strong> @((recommendation.SimilarityScore * 100).ToString("F1"))%
                            </p>
                            <div class="alert alert-info mb-2">
                                <small><strong>Waarom deze auto?</strong><br>@recommendation.Explanation</small>
                            </div>
                            <a href="/car/@carId" 
                               class="btn btn-primary btn-sm w-100" 
                               onclick="event.stopPropagation(); navigateToCarDetail(@carId); return false;"
                               data-car-id="@carId">
                                Bekijk alle foto's
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* 
    JAVASCRIPT FALLBACK - Zorgt ervoor dat routing altijd werkt:
    =============================================================
    - Functie navigateToCarDetail gebruikt expliciet de doorgegeven ID
    - Werkt als fallback als Razor interpolation faalt
    - Gebruikt data-car-id attribute als backup
*@
<script>
        function navigateToCarDetail(carId) {
            // Validatie: check of carId geldig is
            if (carId == null || carId === undefined || isNaN(carId)) {
                console.error('Invalid carId:', carId);
                return;
            }
            
            // Navigeer naar detailpagina
            const url = '/car/' + parseInt(carId, 10);
            window.location.href = url;
        }
    
    // FIX: Event listener voor data-car-id fallback (als onclick niet werkt)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-car-id]').forEach(function(element) {
            // Alleen toevoegen als er nog geen onclick handler is
            if (!element.onclick) {
                element.addEventListener('click', function(e) {
                    const carId = parseInt(this.getAttribute('data-car-id'), 10);
                    if (carId > 0) {
                        navigateToCarDetail(carId);
                    }
                });
            }
        });
    });
</script>
