@page "/car/{id:int}"
@model CarDetailModel
@{
    ViewData["Title"] = Model.Car != null ? $"{Model.Car.Brand} {Model.Car.Model}" : "Auto Details";
    var apiBaseUrl = Model.ApiBaseUrl;
}

@functions {
    string FormatTransmission(string? transmission)
    {
        if (string.IsNullOrWhiteSpace(transmission))
            return "Niet opgegeven";
        
        string lower = transmission.ToLower().Trim();
        
        if (lower.Contains("automatic") || lower.Contains("automaat") || lower.Contains("automatisch") || lower.Contains("cvt") || lower.Contains("dct"))
            return "Automaat";
        
        if (lower.Contains("manual") || lower.Contains("handmatig") || lower.Contains("schakel") || lower.Contains("handbak"))
            return "Handmatig";
        
        return char.ToUpper(transmission[0]) + (transmission.Length > 1 ? transmission.Substring(1).ToLower() : "");
    }
    
    int ConvertKwToHp(int powerKw)
    {
        return (int)Math.Round(powerKw * 1.35962);
    }

    string FormatBodyType(string? bodyType)
    {
        if (string.IsNullOrWhiteSpace(bodyType))
            return "Niet opgegeven";
        
        string lower = bodyType.ToLower().Trim();
        
        return lower switch
        {
            "suv" => "SUV",
            "sedan" => "Sedan",
            "hatchback" => "Hatchback",
            "station" => "Station",
            "cabrio" => "Cabrio",
            "coupe" => "Coupé",
            "wagon" => "Station",
            "convertible" => "Cabrio",
            _ => char.ToUpper(bodyType[0]) + (bodyType.Length > 1 ? bodyType.Substring(1).ToLower() : "")
        };
    }
}

<style>
    :root {
        --deep-purple: #4A148C;
        --purple-dark: #311B92;
        --purple-light: #7B1FA2;
        --purple-accent: #9C27B0;
    }

    .hero-header {
        background: linear-gradient(135deg, #000000 0%, var(--deep-purple) 50%, var(--purple-dark) 100%);
        color: white;
        padding: 3rem 0;
        margin: -1rem -15px 3rem -15px;
        border-radius: 0 0 30px 30px;
    }

    .hero-header h1 {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #424242 0%, #616161 100%);
        border: none;
        font-weight: 600;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
        color: white;
        padding: 0.5rem 1rem;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(66, 66, 66, 0.3);
        background: linear-gradient(135deg, #212121 0%, #424242 100%);
    }

    .details-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
        border-left: 5px solid var(--deep-purple);
    }

    .details-card .card-body {
        padding: 2rem;
    }

    .details-card .card-title {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .details-card dt {
        color: var(--deep-purple);
        font-weight: 600;
        font-size: 1rem;
    }

    .details-card dd {
        color: #333;
        font-size: 1rem;
        margin-bottom: 0.75rem;
    }

    .carousel-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(74, 20, 140, 0.1);
    }

    .carousel-item img {
        border-radius: 12px;
    }

    .car-placeholder {
        border-radius: 12px;
    }

    .image-gallery {
        margin-top: 3rem;
    }

    .image-gallery h3 {
        color: var(--deep-purple);
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .img-thumbnail {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .img-thumbnail:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(74, 20, 140, 0.2);
        border-color: var(--deep-purple);
    }

    .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .alert-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: none;
        border-left: 4px solid #d32f2f;
        color: #333;
        border-radius: 8px;
        padding: 1rem 1.5rem;
    }

    @@media (max-width: 992px) {
        .hero-header h1 {
            font-size: 1.75rem;
        }
    }
</style>

<div class="hero-header">
    <div class="container-fluid">
        <div class="content-wrapper">
            @if (Model.Car != null)
            {
                <h1>@Model.Car.Brand @Model.Car.Model</h1>
            }
            else
            {
                <h1>Auto Details</h1>
            }
        </div>
    </div>
</div>

<div class="content-wrapper">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Fout:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.Car != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <a href="/" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Terug naar zoeken
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card details-card">
                    <div class="card-body">
                        <h3 class="card-title">Specificaties</h3>
                        <dl class="row">
                            <dt class="col-sm-5">Prijs:</dt>
                            <dd class="col-sm-7">€@Model.Car.Budget.ToString("N0")</dd>

                            <dt class="col-sm-5">Brandstof:</dt>
                            <dd class="col-sm-7">@Model.Car.Fuel</dd>

                            <dt class="col-sm-5">Bouwjaar:</dt>
                            <dd class="col-sm-7">@Model.Car.Year</dd>

                            <dt class="col-sm-5">Vermogen:</dt>
                            <dd class="col-sm-7">@ConvertKwToHp(Model.Car.Power) PK</dd>

                            <dt class="col-sm-5">Transmissie:</dt>
                            <dd class="col-sm-7">@FormatTransmission(Model.Car.Transmission)</dd>

                            @if (!string.IsNullOrWhiteSpace(Model.Car.BodyType))
                            {
                                <dt class="col-sm-5">Carrosserie:</dt>
                                <dd class="col-sm-7">@FormatBodyType(Model.Car.BodyType)</dd>
                            }

                            @if (!string.IsNullOrWhiteSpace(Model.Car.DriveType))
                            {
                                <dt class="col-sm-5">Aandrijving:</dt>
                                <dd class="col-sm-7">@Model.Car.DriveType</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                @{
                    // Negeer API ImageUrl en probeer direct Auto-Data.net
                    var safeBrand = Model.Car.Brand?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                    var safeModel = Model.Car.Model?.Trim().Replace(" ", "-").Replace("&", "and").ToLower() ?? "";
                    var mainImageUrl = $"https://www.auto-data.net/images/{safeBrand}/{safeModel}.jpg";
                    
                    var brandLower = Model.Car.Brand?.ToLower() ?? "auto";
                    var modelLower = Model.Car.Model?.ToLower() ?? "";
                }
                
                <div class="carousel-container">
                    <img src="@mainImageUrl" 
                         class="d-block w-100" 
                         alt="@Model.Car.Brand @Model.Car.Model"
                         style="height: 400px; object-fit: cover; display: block; width: 100%;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         loading="lazy">
                    <div class="car-placeholder" 
                         style="display: none; height: 400px; background: #2d2d2d; flex-direction: column; align-items: center; justify-content: center; color: #ccc;">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor" style="margin-bottom: 1.5rem;">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                        <div style="font-size: 1.3rem; font-weight: 500; text-align: center;">
                            @brandLower<br>
                            @modelLower
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.Images.Count > 1)
        {
            <div class="row image-gallery">
                <div class="col-12">
                    <h3>Alle Foto's</h3>
                    <div class="row">
                        @foreach (var imageUrl in Model.Images)
                        {
                            var imageSrc = imageUrl;
                            if (!string.IsNullOrEmpty(imageSrc) && imageSrc.StartsWith("/") && !string.IsNullOrEmpty(apiBaseUrl))
                            {
                                imageSrc = apiBaseUrl + imageSrc;
                            }
                            <div class="col-md-3 col-sm-4 col-6 mb-3">
                                <img src="@imageSrc" 
                                     class="img-thumbnail w-100" 
                                     alt="@Model.Car.Brand @Model.Car.Model"
                                     style="height: 200px; object-fit: cover; cursor: pointer;"
                                     onclick="showImageModal('@imageSrc')"
                                     onerror="this.style.display='none';">
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--deep-purple) 0%, var(--purple-accent) 100%); color: white;">
                <h5 class="modal-title">@(Model.Car?.Brand) @(Model.Car?.Model)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" style="background: #f5f5f5;">
                <img id="modalImage" src="" class="img-fluid" alt="@(Model.Car?.Brand) @(Model.Car?.Model)">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            var modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }
    </script>
}
